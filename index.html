<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดเก็บประวัติการฝึกอบรมพนักงาน</title>
    
    <!-- CSS: Tailwind CSS (CDN) สำหรับการออกแบบ UI ที่รวดเร็วและเป็น Modern Design -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CSS: Google Fonts (Prompt สำหรับภาษาไทย) -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS: Phosphor Icons สำหรับไอคอนสวยงาม -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- CSS: Custom Styles & Animations -->
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f1f5f9; /* สีเทาอมฟ้าอ่อนๆ สบายตา */
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.5s ease-out forwards; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .view-hidden { display: none !important; }

        /* Toast Notification Styles */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            min-width: 250px; background: white; border-radius: 8px; padding: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex; align-items: center; gap: 12px;
            transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.info { border-left: 4px solid #3b82f6; }

        /* Custom Scrollbar for modern look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen flex flex-col">

    <div id="toast-container"></div>

    <!-- ========================================== -->
    <!-- HTML: Login View (คงเดิมตามสั่ง)           -->
    <!-- ========================================== -->
    <div id="view-login" class="flex-1 flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 slide-up">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph ph-graduation-cap text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">Training Records</h1>
                <p class="text-sm text-gray-500 mt-2">เข้าสู่ระบบด้วย PIN ของคุณ</p>
            </div>
            <form id="form-login" class="space-y-6">
                <div>
                    <label for="login-pin" class="block text-sm font-medium text-gray-700 mb-1">รหัส PIN 6 หลัก</label>
                    <div class="relative">
                        <i class="ph ph-lock-key absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg"></i>
                        <input type="password" id="login-pin" required pattern="[0-9]{6}" placeholder="••••••" maxlength="6"
                            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-center tracking-[0.5em] font-bold text-lg">
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                    เข้าสู่ระบบ <i class="ph ph-sign-in"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- HTML: Force PIN Change View (คงเดิมตามสั่ง) -->
    <!-- ========================================== -->
    <div id="view-force-pin" class="flex-1 items-center justify-center p-4 view-hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph ph-shield-warning text-3xl"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-900">บังคับเปลี่ยนรหัส PIN</h2>
                <p class="text-sm text-gray-500 mt-2">นี่คือการเข้าสู่ระบบครั้งแรกของคุณ<br>กรุณาตั้งรหัส PIN ใหม่เพื่อความปลอดภัย</p>
            </div>
            <form id="form-change-pin" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">PIN ใหม่ (6 หลัก)</label>
                    <input type="password" id="new-pin" required pattern="[0-9]{6}" placeholder="••••••" maxlength="6"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-center tracking-[0.5em] font-bold">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ยืนยัน PIN ใหม่</label>
                    <input type="password" id="confirm-new-pin" required pattern="[0-9]{6}" placeholder="••••••" maxlength="6"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-center tracking-[0.5em] font-bold">
                </div>
                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 rounded-lg transition-colors mt-4">
                    บันทึก PIN ใหม่และเข้าสู่ระบบ
                </button>
            </form>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- HTML: Admin Dashboard                      -->
    <!-- ========================================== -->
    <div id="view-admin" class="flex-1 flex flex-col view-hidden bg-slate-50">
        <!-- Navbar -->
        <nav class="bg-white/80 backdrop-blur-md shadow-sm px-6 py-4 flex justify-between items-center sticky top-0 z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 shadow-md text-white rounded-xl flex items-center justify-center">
                    <i class="ph ph-user-gear text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-800 text-lg tracking-wide">Admin Dashboard</h1>
                    <p class="text-xs text-gray-500">จัดการพนักงานและประวัติการอบรม</p>
                </div>
            </div>
            <button onclick="logout()" class="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg transition flex items-center gap-2 text-sm font-medium">
                <i class="ph ph-sign-out"></i> ออกจากระบบ
            </button>
        </nav>

        <!-- Main Content -->
        <div class="p-6 max-w-7xl mx-auto w-full space-y-6 flex-1">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Add New Employee Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 md:col-span-1">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                        <i class="ph ph-user-plus text-blue-500 text-xl"></i> เพิ่มพนักงานใหม่
                    </h3>
                    <form id="form-add-employee" class="space-y-4">
                        <div>
                            <input type="text" id="emp-name" required placeholder="ชื่อ-นามสกุลพนักงาน" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all bg-gray-50 focus:bg-white">
                        </div>
                        <div>
                            <input type="text" id="emp-pin" required pattern="[0-9]{6}" maxlength="6" placeholder="กำหนด PIN เริ่มต้น (6 หลัก)" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm tracking-widest transition-all bg-gray-50 focus:bg-white">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white shadow-md hover:bg-blue-700 font-medium py-3 rounded-xl transition-colors text-sm">
                            สร้างบัญชีพนักงาน
                        </button>
                    </form>
                </div>

                <!-- Employees List -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 md:col-span-2 overflow-hidden flex flex-col">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                        <i class="ph ph-users text-blue-500 text-xl"></i> รายชื่อพนักงานทั้งหมด
                    </h3>
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-left text-base text-gray-600">
                            <thead class="bg-gray-50/80 text-gray-700 uppercase text-xs font-bold tracking-wider">
                                <tr>
                                    <th class="px-4 py-3 rounded-tl-lg">ชื่อพนักงาน</th>
                                    <th class="px-4 py-3">สถานะ Login แรก</th>
                                    <th class="px-4 py-3 text-center rounded-tr-lg">จำนวนการอบรม</th>
                                </tr>
                            </thead>
                            <tbody id="admin-employee-list" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- All Training Records -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                    <i class="ph ph-books text-blue-500 text-xl"></i> ประวัติการฝึกอบรมทั้งหมด (All Records)
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-base text-gray-600">
                        <thead class="bg-gray-50/80 text-gray-700 uppercase text-xs font-bold tracking-wider">
                            <tr>
                                <th class="px-4 py-3 rounded-tl-lg">พนักงาน</th>
                                <th class="px-4 py-3">ชื่อหลักสูตร / สัมมนา</th>
                                <th class="px-4 py-3">ประเภท</th>
                                <th class="px-4 py-3">วันที่/เวลาอบรม</th>
                                <th class="px-4 py-3 text-center rounded-tr-lg">ไฟล์แนบ</th>
                            </tr>
                        </thead>
                        <tbody id="admin-records-list" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- HTML: Employee Dashboard                   -->
    <!-- ========================================== -->
    <div id="view-employee" class="flex-1 flex flex-col view-hidden bg-slate-50">
        <!-- Navbar -->
        <nav class="bg-white/80 backdrop-blur-md shadow-sm px-6 py-4 flex justify-between items-center sticky top-0 z-10">
            <div class="flex items-center gap-3">
                <img id="emp-profile-img" src="" alt="Profile" class="w-10 h-10 rounded-xl object-cover hidden shadow-sm">
                <div id="emp-profile-icon" class="w-10 h-10 bg-emerald-500 shadow-md text-white rounded-xl flex items-center justify-center">
                    <i class="ph ph-user text-xl"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <h1 id="emp-welcome-name" class="font-bold text-gray-800 text-lg tracking-wide">My Training Profile</h1>
                        <button onclick="openEditProfileModal()" class="text-gray-400 hover:text-emerald-600 transition" title="แก้ไขโปรไฟล์">
                            <i class="ph ph-pencil-simple text-lg"></i>
                        </button>
                    </div>
                    <p id="emp-position-email" class="text-xs text-gray-500">ยินดีต้อนรับ</p>
                </div>
            </div>
            <button onclick="logout()" class="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg transition flex items-center gap-2 text-sm font-medium">
                <i class="ph ph-sign-out"></i> ออกจากระบบ
            </button>
        </nav>

        <div class="p-6 max-w-5xl mx-auto w-full flex-1">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-gray-100">
                
                <!-- Dashboard Header: Title, Filters & Buttons -->
                <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 mb-8 pb-6 border-b border-gray-100">
                    <div class="flex flex-wrap items-center gap-3">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2 text-xl md:text-2xl shrink-0 whitespace-nowrap">
                            <i class="ph ph-list-dashes text-emerald-500 text-3xl"></i> ประวัติการฝึกอบรม
                        </h3>
                        <span id="emp-total-records" class="text-sm bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full font-semibold border border-emerald-100 shadow-sm shrink-0 whitespace-nowrap">0 รายการ</span>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3 w-full xl:w-auto">
                        <div class="relative flex-1 min-w-[200px]">
                            <i class="ph ph-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg"></i>
                            <input type="text" id="search-record" oninput="renderEmployeeDashboard()" placeholder="ค้นหาชื่อหลักสูตร, สถานที่..." class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm transition-all bg-gray-50 focus:bg-white">
                        </div>
                        
                        <div class="flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-xl px-3 py-1.5">
                            <span class="text-xs font-medium text-gray-500">ตั้งแต่</span>
                            <input type="date" id="search-start-date" onchange="renderEmployeeDashboard()" class="bg-transparent outline-none text-sm font-medium text-gray-700 cursor-pointer">
                            <span class="text-xs font-medium text-gray-500">ถึง</span>
                            <input type="date" id="search-end-date" onchange="renderEmployeeDashboard()" class="bg-transparent outline-none text-sm font-medium text-gray-700 cursor-pointer">
                        </div>

                        <div class="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                            <button type="button" onclick="exportToExcel()" class="flex-1 sm:flex-none bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 px-4 rounded-xl flex items-center justify-center gap-2 transition-colors shadow-sm shadow-indigo-200 text-sm">
                                <i class="ph ph-file-xls text-lg"></i> Export
                            </button>
                            <button type="button" onclick="openAddRecordModal()" class="flex-1 sm:flex-none bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2.5 px-4 rounded-xl flex items-center justify-center gap-2 transition-colors shadow-sm shadow-emerald-200 text-sm">
                                <i class="ph ph-plus-circle text-lg"></i> เพิ่มข้อมูล
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="emp-my-records" class="space-y-4">
                    <div class="text-center text-gray-400 py-12 text-base">
                        <i class="ph ph-empty text-5xl mb-3 opacity-50"></i>
                        <p>ยังไม่มีประวัติการฝึกอบรม</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- HTML Modals                                -->
    <!-- ========================================== -->
    
    <!-- Modal: Edit Profile -->
    <div id="modal-edit-profile" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 fade-in border border-gray-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-gray-900">แก้ไขข้อมูลส่วนตัว</h3>
                <button onclick="closeEditProfileModal()" class="text-gray-400 hover:text-gray-600 bg-gray-50 hover:bg-gray-100 p-2 rounded-full transition"><i class="ph ph-x text-xl"></i></button>
            </div>
            <!-- ... form content same ... -->
            <form id="form-edit-profile" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล</label>
                    <input type="text" id="edit-profile-name" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ตำแหน่ง</label>
                    <input type="text" id="edit-profile-position" placeholder="เช่น พนักงานทั่วไป" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                    <input type="email" id="edit-profile-email" placeholder="example@email.com" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">รูปโปรไฟล์ (ตัวเลือก)</label>
                    <input type="file" id="edit-profile-pic" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 transition-colors">
                </div>
                <div class="pt-6 flex gap-3">
                    <button type="button" onclick="closeEditProfileModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl transition-colors">ยกเลิก</button>
                    <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md shadow-emerald-200">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Verify PIN for Edit -->
    <div id="modal-verify-pin" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 fade-in text-center border border-gray-100">
            <h3 class="font-bold text-xl text-gray-900 mb-2">ยืนยันตัวตน</h3>
            <p class="text-sm text-gray-500 mb-6">กรุณาใส่รหัส PIN เพื่อแก้ไขประวัติการอบรม</p>
            <form id="form-verify-pin" class="space-y-5">
                <input type="password" id="verify-pin-input" required pattern="[0-9]{6}" maxlength="6" placeholder="••••••" class="w-full px-4 py-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 text-center tracking-[0.7em] font-bold text-lg bg-gray-50 focus:bg-white transition-all">
                <div class="flex gap-3">
                    <button type="button" onclick="closeVerifyPinModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl transition-colors">ยกเลิก</button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md shadow-blue-200">ยืนยัน</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Delete Confirmation -->
    <div id="modal-delete-confirm" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 fade-in text-center border border-gray-100">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph ph-trash text-3xl"></i>
            </div>
            <h3 class="font-bold text-xl text-gray-900 mb-2">ยืนยันการลบข้อมูล</h3>
            <p class="text-sm text-gray-500 mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบประวัติการอบรมนี้? การกระทำนี้ไม่สามารถกู้คืนได้</p>
            <div class="flex gap-3">
                <button type="button" onclick="closeDeleteModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl transition-colors">ยกเลิก</button>
                <button type="button" onclick="confirmDelete()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md shadow-red-200">ลบข้อมูล</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Training Record -->
    <div id="modal-add-record" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 fade-in max-h-[90vh] overflow-y-auto border border-gray-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-gray-900">เพิ่มการอบรม</h3>
                <button type="button" onclick="closeAddRecordModal()" class="text-gray-400 hover:text-gray-600 bg-gray-50 hover:bg-gray-100 p-2 rounded-full transition"><i class="ph ph-x text-xl"></i></button>
            </div>
            <form id="form-add-record" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-สกุล</label>
                    <input type="text" id="add-record-emp-name" readonly class="w-full px-4 py-3 border border-gray-200 bg-gray-50 text-gray-500 rounded-xl outline-none cursor-not-allowed">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อหลักสูตรฝึกอบรม/สัมมนา/ดูงาน</label>
                    <input type="text" id="add-record-course" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ประเภทการอบรม</label>
                    <select id="add-record-type" required onchange="toggleAddRecordType()" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none mb-2 bg-white transition-all cursor-pointer">
                        <option value="">-- เลือกประเภทการอบรม --</option>
                        <option value="IN">IN</option>
                        <option value="EX">EX</option>
                        <option value="OJT">OJT</option>
                        <option value="OTHER">อื่นๆ</option>
                    </select>
                    <input type="text" id="add-record-type-other" placeholder="โปรดระบุประเภทการอบรมอื่นๆ" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none hidden mb-2 transition-all">
                    <div class="text-xs text-gray-500 bg-blue-50/50 p-3 rounded-xl border border-blue-100 space-y-1.5">
                        <p><b>IN:</b> วิทยากรภายในหน่วยหรือศูนย์ชันสูตรฯเป็นผู้จัดการอบรม</p>
                        <p><b>EX:</b> วิทยากรภายนอกหรือเดินทางไปอบรมโดยที่ศูนย์ชันสูตรฯไม่ได้เป็นผู้จัดการอบรม</p>
                        <p><b>OJT:</b> On the job training/การฝึกอบรมการปฏิบัติงาน</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">หน่วยงานที่จัดอบรม</label>
                    <input type="text" id="add-record-organizer" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">สถานที่อบรม</label>
                    <input type="text" id="add-record-location" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <!-- เปลี่ยนจาก date เป็น datetime-local เพื่อให้เลือกเวลาได้ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">วัน/เดือน/ปี และเวลา</label>
                    <input type="datetime-local" id="add-record-date" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all cursor-pointer">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">อัปโหลด Cer (รูปภาพ หรือ PDF)</label>
                    <div class="flex items-center gap-2">
                        <input type="file" id="add-record-file" accept=".pdf, image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 transition-colors">
                        <!-- ปุ่มเคลียร์ไฟล์ -->
                        <button type="button" onclick="clearFileInput('add-record-file')" class="shrink-0 text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors text-sm font-medium flex items-center gap-1" title="ลบไฟล์ที่เลือก">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="pt-6 flex gap-3">
                    <button type="button" onclick="closeAddRecordModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl transition-colors">ยกเลิก</button>
                    <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md shadow-emerald-200">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Training Record -->
    <div id="modal-edit-record" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 fade-in max-h-[90vh] overflow-y-auto border border-gray-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-gray-900">แก้ไขประวัติการอบรม</h3>
                <button type="button" onclick="closeEditRecordModal()" class="text-gray-400 hover:text-gray-600 bg-gray-50 hover:bg-gray-100 p-2 rounded-full transition"><i class="ph ph-x text-xl"></i></button>
            </div>
            <form id="form-edit-record" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-สกุล</label>
                    <input type="text" id="edit-record-emp-name" readonly class="w-full px-4 py-3 border border-gray-200 bg-gray-50 text-gray-500 rounded-xl outline-none cursor-not-allowed">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อหลักสูตรฝึกอบรม/สัมมนา/ดูงาน</label>
                    <input type="text" id="edit-record-course" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ประเภทการอบรม</label>
                    <select id="edit-record-type" required onchange="toggleEditRecordType()" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none mb-2 bg-white transition-all cursor-pointer">
                        <option value="">-- เลือกประเภทการอบรม --</option>
                        <option value="IN">IN</option>
                        <option value="EX">EX</option>
                        <option value="OJT">OJT</option>
                        <option value="OTHER">อื่นๆ</option>
                    </select>
                    <input type="text" id="edit-record-type-other" placeholder="โปรดระบุประเภทการอบรมอื่นๆ" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none hidden mb-2 transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">หน่วยงานที่จัดอบรม</label>
                    <input type="text" id="edit-record-organizer" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">สถานที่อบรม</label>
                    <input type="text" id="edit-record-location" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <!-- เปลี่ยนจาก date เป็น datetime-local -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">วัน/เดือน/ปี และเวลา</label>
                    <input type="datetime-local" id="edit-record-date" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all cursor-pointer">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">อัปเดตไฟล์แนบใหม่ (เว้นว่างไว้หากใช้ไฟล์เดิม)</label>
                    <div class="flex items-center gap-2">
                        <input type="file" id="edit-record-file" accept=".pdf, image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 transition-colors">
                        <!-- ปุ่มเคลียร์ไฟล์ -->
                        <button type="button" onclick="clearFileInput('edit-record-file')" class="shrink-0 text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors text-sm font-medium flex items-center gap-1" title="ลบไฟล์ที่เลือก">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="pt-6 flex gap-3">
                    <button type="button" onclick="closeEditRecordModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl transition-colors">ยกเลิก</button>
                    <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md shadow-emerald-200">บันทึกการแก้ไข</button>
                </div>
            </form>
        </div>
    </div>


    <!-- ========================================== -->
    <!-- JAVASCRIPT: Logic & Firebase Preparation   -->
    <!-- ========================================== -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    // นำเข้า deleteDoc เพิ่มเติม
    import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, setDoc, getCountFromServer, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBi0lGbAip6cwm2v88BHBPL51TnR5PARQ0",
        authDomain: "employee-training-record.firebaseapp.com",
        projectId: "employee-training-record",
        storageBucket: "employee-training-record.firebasestorage.app",
        messagingSenderId: "603035626082",
        appId: "1:603035626082:web:10e27c482ffcdc944f7f3b"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);

    let currentUser = null;
    let editingRecordId = null;
    let deletingRecordId = null; // สำหรับยืนยันการลบ
    window.loadedRecords = {}; 
    window.currentFilteredRecords = []; // เก็บข้อมูลที่ผ่านการกรองแล้วสำหรับการ Export

    const logActivity = async (actionName, details) => {
        const now = new Date();
        const timestampStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}${now.getSeconds().toString().padStart(2,'0')}`;
        const userName = currentUser ? currentUser.name.replace(/\s+/g, '_') : "Unknown";
        const docId = `${actionName}_${userName}_${timestampStr}`;
        try {
            await setDoc(doc(db, "activity_logs", docId), {
                action: actionName,
                user: currentUser ? currentUser.name : "System",
                details: details,
                timestamp: now,
                dateDisplay: now.toLocaleString('th-TH')
            });
        } catch (e) { console.error("Log failed:", e); }
    };

    const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            if (!file.type.startsWith('image/')) {
                resolve(event.target.result);
                return;
            }
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1000; 
                let width = img.width;
                let height = img.height;
                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', 0.6));
            };
        };
        reader.onerror = error => reject(error);
    });

    window.showToast = (message, type = 'info') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        let icon = 'ph-info';
        if(type === 'success') icon = 'ph-check-circle text-emerald-500';
        if(type === 'error') icon = 'ph-warning-circle text-red-500';
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="ph ${icon} text-2xl"></i><div class="text-sm font-medium text-gray-700">${message}</div>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    };

    window.navigateTo = (viewId) => {
        document.getElementById('view-login').classList.add('view-hidden');
        document.getElementById('view-force-pin').classList.add('view-hidden');
        document.getElementById('view-admin').classList.add('view-hidden');
        document.getElementById('view-employee').classList.add('view-hidden');
        const targetView = document.getElementById(viewId);
        targetView.classList.remove('view-hidden');
        void targetView.offsetWidth;
        targetView.classList.add('fade-in');
    };

    window.viewFile = (id) => {
        const rec = window.loadedRecords[id];
        if (!rec || !rec.fileUrl) { showToast('ไม่พบไฟล์แนบ', 'error'); return; }
        try {
            const arr = rec.fileUrl.split(',');
            if (arr.length !== 2) throw new Error('Invalid Data');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--) { u8arr[n] = bstr.charCodeAt(n); }
            const blob = new Blob([u8arr], {type: mime});
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl, '_blank');
        } catch (err) { console.error(err); showToast('ไฟล์มีปัญหา ไม่สามารถเปิดได้', 'error'); }
    };

    // ฟังก์ชันล้างค่า input file
    window.clearFileInput = (inputId) => {
        document.getElementById(inputId).value = '';
    };

    // ==========================================
    // Authentication
    // ==========================================
    document.getElementById('login-pin').addEventListener('input', function(e) {
        if (this.value.length === 6) {
            setTimeout(() => { document.getElementById('form-login').requestSubmit(); }, 100);
        }
    });

    document.getElementById('form-login').addEventListener('submit', async (e) => {
        e.preventDefault();
        const pinInput = document.getElementById('login-pin').value;
        try {
            const q = query(collection(db, "users"), where("pin", "==", pinInput));
            const snap = await getDocs(q);
            if (!snap.empty) {
                currentUser = { id: snap.docs[0].id, ...snap.docs[0].data() };
                document.getElementById('login-pin').value = '';
                if (currentUser.role === 'admin') { 
                    await logActivity("Login_Admin", "แอดมินเข้าสู่ระบบ");
                    renderAdminDashboard(); 
                    navigateTo('view-admin'); 
                }
                else {
                    if (currentUser.isFirstLogin) navigateTo('view-force-pin');
                    else { renderEmployeeDashboard(); navigateTo('view-employee'); }
                }
            } else showToast('รหัส PIN ไม่ถูกต้อง', 'error');
        } catch (err) { showToast('เชื่อมต่อฐานข้อมูลล้มเหลว', 'error'); }
    });

    window.logout = () => { currentUser = null; navigateTo('view-login'); showToast('ออกจากระบบแล้ว', 'info'); };

    document.getElementById('form-change-pin').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPin = document.getElementById('new-pin').value;
        if (newPin !== document.getElementById('confirm-new-pin').value) { showToast('PIN ไม่ตรงกัน', 'error'); return; }
        try {
            const qPin = query(collection(db, "users"), where("pin", "==", newPin));
            const pinSnap = await getDocs(qPin);
            if (!pinSnap.empty) { showToast('PIN นี้มีคนใช้แล้ว โปรดใช้เลขอื่น', 'error'); return; }

            await updateDoc(doc(db, "users", currentUser.id), { pin: newPin, isFirstLogin: false });
            currentUser.pin = newPin; currentUser.isFirstLogin = false;
            renderEmployeeDashboard(); navigateTo('view-employee');
            await logActivity("Change_PIN", "ผู้ใช้เปลี่ยนรหัส PIN ใหม่ด้วยตนเอง");
            showToast('เปลี่ยนรหัสสำเร็จ', 'success');
        } catch (err) { showToast('บันทึกล้มเหลว', 'error'); }
    });

    // ==========================================
    // Admin Dashboard Logic
    // ==========================================
    window.renderAdminDashboard = async () => {
        const empTbody = document.getElementById('admin-employee-list');
        const recTbody = document.getElementById('admin-records-list');
        empTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-sm text-gray-400 italic">กำลังโหลดรายชื่อพนักงาน...</td></tr>';

        const usersSnap = await getDocs(query(collection(db, "users"), where("role", "==", "employee")));
        const recordsSnap = await getDocs(collection(db, "training_records"));
        const allRecs = recordsSnap.docs.map(d => ({id: d.id, ...d.data()}));
        window.loadedRecords = {}; allRecs.forEach(r => window.loadedRecords[r.id] = r);

        empTbody.innerHTML = '';
        usersSnap.forEach(uDoc => {
            const emp = uDoc.data();
            const count = allRecs.filter(r => r.userId === uDoc.id).length;
            empTbody.innerHTML += `
                <tr class="hover:bg-blue-50/50 transition-colors border-b border-gray-100">
                    <td class="px-4 py-4 font-bold text-gray-800">${emp.name}</td>
                    <td class="px-4 py-4">${emp.isFirstLogin ? '<span class="text-yellow-600 font-medium text-sm">รอเปลี่ยน PIN</span>' : '<span class="text-emerald-600 font-medium text-sm">ปกติ</span>'}</td>
                    <td class="px-4 py-4 text-center"><span class="bg-blue-100 text-blue-800 font-bold px-3 py-1 rounded-lg text-sm">${count}</span></td>
                </tr>`;
        });

        recTbody.innerHTML = '';
        allRecs.sort((a,b) => b.numericId - a.numericId).forEach(rec => {
            const owner = usersSnap.docs.find(d => d.id === rec.userId)?.data()?.name || 'N/A';
            const displayDate = rec.date.replace('T', ' เวลา ') + (rec.date.includes('T') ? ' น.' : '');
            recTbody.innerHTML += `
                <tr class="hover:bg-blue-50/50 transition-colors border-b border-gray-100">
                    <td class="px-4 py-4 font-bold text-gray-800">${owner}</td>
                    <td class="px-4 py-4 text-base">${rec.course}<br><span class="text-xs text-gray-500 font-medium mt-1 inline-block">${rec.organizer}</span></td>
                    <td class="px-4 py-4 text-sm font-medium"><span class="bg-gray-100 px-2 py-1 rounded-md">${rec.type === 'OTHER' ? rec.typeOther : rec.type}</span></td>
                    <td class="px-4 py-4 text-sm">${displayDate}</td>
                    <td class="px-4 py-4 text-center">${rec.fileUrl ? `<button onclick="viewFile('${rec.id}')" class="text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition"><i class="ph ph-file-pdf text-xl"></i></button>` : '-'}</td>
                </tr>`;
        });
    };

    document.getElementById('form-add-employee').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('emp-name').value;
        const pin = document.getElementById('emp-pin').value;
        try {
            const qPin = query(collection(db, "users"), where("pin", "==", pin));
            const pinSnap = await getDocs(qPin);
            if (!pinSnap.empty) { showToast('PIN นี้มีผู้ใช้งานแล้ว โปรดตั้งเลขอื่น', 'error'); return; }

            await setDoc(doc(db, "users", name), { name, pin, role: 'employee', isFirstLogin: true });
            document.getElementById('emp-name').value = ''; document.getElementById('emp-pin').value = '';
            await logActivity("Admin_Add_Employee", `แอดมินเพิ่มพนักงานใหม่ชื่อ: ${name}`);
            showToast('เพิ่มพนักงานสำเร็จ', 'success'); renderAdminDashboard();
        } catch (err) { showToast('บันทึกล้มเหลว: ' + err.message, 'error'); }
    });

    // ==========================================
    // Employee Dashboard Logic & Excel Export
    // ==========================================
    window.exportToExcel = () => {
        const data = window.currentFilteredRecords;
        if(!data || data.length === 0) {
            showToast('ไม่มีข้อมูลสำหรับ Export', 'error');
            return;
        }

        // สร้าง CSV format พร้อม BOM เพื่อให้ Excel อ่านภาษาไทยได้
        let csvContent = "\uFEFF"; 
        csvContent += "รหัสรายการ,ชื่อหลักสูตร/สัมมนา,ประเภท,หน่วยงานที่จัด,สถานที่อบรม,วันที่อบรม,เวลา\n";

        data.forEach(r => {
            const parts = r.date.split('T');
            const datePart = parts[0] || '';
            const timePart = parts[1] || '';
            const typeStr = r.type === 'OTHER' ? r.typeOther : r.type;

            // ป้องกันเครื่องหมายคอมม่า (,) หรือเครื่องหมายคำพูด (") ในข้อมูลทำให้คอลัมน์เพี้ยน
            const row = [
                `"${r.numericId}"`,
                `"${r.course.replace(/"/g, '""')}"`,
                `"${typeStr}"`,
                `"${r.organizer.replace(/"/g, '""')}"`,
                `"${r.location.replace(/"/g, '""')}"`,
                `"${datePart}"`,
                `"${timePart}"`
            ].join(",");
            csvContent += row + "\n";
        });

        // สร้างไฟล์สำหรับดาวน์โหลด
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `Training_Records_${currentUser.name.replace(/\s+/g,'_')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Export ไฟล์สำเร็จ', 'success');
    };

    window.renderEmployeeDashboard = async () => {
        document.getElementById('emp-welcome-name').innerText = currentUser.name;
        const profileImg = document.getElementById('emp-profile-img');
        const profileIcon = document.getElementById('emp-profile-icon');
        if (currentUser.profilePic) { 
            profileImg.src = currentUser.profilePic; profileImg.classList.remove('hidden'); profileIcon.classList.add('hidden'); 
        } else { 
            profileImg.classList.add('hidden'); profileIcon.classList.remove('hidden'); 
        }

        const recordsContainer = document.getElementById('emp-my-records');
        recordsContainer.innerHTML = '<p class="text-center py-12 text-gray-400 text-lg animate-pulse">กำลังโหลดข้อมูลของคุณ...</p>';

        const q = query(collection(db, "training_records"), where("userId", "==", currentUser.id));
        const snap = await getDocs(q);
        let myRecs = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        window.loadedRecords = {};
        myRecs.forEach(r => window.loadedRecords[r.id] = r);

        // Filters
        const term = document.getElementById('search-record').value.toLowerCase();
        const startDate = document.getElementById('search-start-date').value;
        const endDate = document.getElementById('search-end-date').value;
        
        if (term) myRecs = myRecs.filter(r => r.course.toLowerCase().includes(term) || r.organizer.toLowerCase().includes(term) || r.location.toLowerCase().includes(term));
        
        // กรองตามช่วงเวลา (เปรียบเทียบสตริง YYYY-MM-DD ได้เลยเพราะ format เรียงถูกต้อง)
        if (startDate) {
            myRecs = myRecs.filter(r => r.date >= startDate);
        }
        if (endDate) {
            // เพื่อให้รวมถึงเวลาในวันสิ้นสุดได้ครบถ้วน (T23:59)
            const endDateTime = endDate + "T23:59";
            myRecs = myRecs.filter(r => r.date <= endDateTime);
        }

        // จัดเก็บข้อมูลที่ผ่านการกรองแล้วสำหรับการ Export
        window.currentFilteredRecords = [...myRecs];

        document.getElementById('emp-total-records').innerText = `${myRecs.length} รายการ`;
        if (myRecs.length === 0) { 
            recordsContainer.innerHTML = '<div class="text-center py-12 text-gray-400 text-base"><i class="ph ph-empty text-5xl mb-3 opacity-50"></i><p>ไม่พบข้อมูลประวัติในช่วงเวลาที่ระบุ</p></div>'; 
            return; 
        }

        const grouped = {};
        myRecs.forEach(rec => {
            const y = rec.date.substring(0, 4);
            if (!grouped[y]) grouped[y] = [];
            grouped[y].push(rec);
        });

        recordsContainer.innerHTML = '';
        let displayIndex = 1;
        Object.keys(grouped).sort((a,b) => b-a).forEach(y => {
            let html = `<div class="mb-8"><div class="flex items-center gap-3 mb-5 pl-3 border-l-4 border-emerald-500"><h4 class="text-2xl font-black text-gray-800">ปี ${y}</h4></div><div class="space-y-5">`;
            grouped[y].sort((a,b) => (b.date > a.date ? 1 : -1)).forEach(rec => {
                const displayDate = rec.date.replace('T', ' เวลา ') + (rec.date.includes('T') ? ' น.' : '');
                
                html += `
                    <div class="border border-gray-100 rounded-2xl p-6 bg-white shadow-sm hover:shadow-md transition-shadow relative group">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div class="flex-1">
                                <span class="bg-indigo-600 text-white text-xs font-bold px-2.5 py-1 rounded-md shadow-sm">ลำดับ ${displayIndex} (ID: ${rec.numericId})</span>
                                <!-- ขยายขนาด Font ตรงนี้เป็น text-xl -->
                                <h4 class="font-bold text-gray-900 text-xl mt-3 leading-tight">${rec.course}</h4>
                                <div class="flex flex-wrap gap-2 mt-3">
                                    <span class="text-sm font-medium bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full border border-emerald-100"><i class="ph ph-calendar-blank inline-block mr-1"></i> ${displayDate}</span>
                                    <span class="text-sm font-medium bg-purple-50 text-purple-700 px-3 py-1 rounded-full border border-purple-100"><i class="ph ph-tag inline-block mr-1"></i> ${rec.type === 'OTHER' ? rec.typeOther : rec.type}</span>
                                </div>
                            </div>
                            <!-- กลุ่มปุ่มจัดการ เปลี่ยนให้อยู่ด้วยกันและดีไซน์ดูสวยขึ้น -->
                            <div class="flex flex-row sm:flex-col gap-2 w-full sm:w-auto mt-4 sm:mt-0">
                                <button onclick="requestEditRecord('${rec.id}')" class="flex-1 sm:flex-none text-sm bg-gray-50 border border-gray-200 px-4 py-2 rounded-xl hover:bg-emerald-50 hover:text-emerald-700 hover:border-emerald-200 font-bold transition flex items-center justify-center gap-1"><i class="ph ph-pencil-simple"></i> แก้ไข</button>
                                <button onclick="openDeleteModal('${rec.id}')" class="flex-1 sm:flex-none text-sm bg-red-50 text-red-600 border border-red-100 px-4 py-2 rounded-xl hover:bg-red-100 hover:border-red-200 font-bold transition flex items-center justify-center gap-1"><i class="ph ph-trash"></i> ลบ</button>
                            </div>
                        </div>
                        <!-- ขยายขนาด Font รายละเอียดเป็น text-base -->
                        <div class="mt-5 text-base text-gray-700 bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <p class="mb-1"><i class="ph ph-buildings text-gray-400 mr-1"></i> <b class="font-semibold text-gray-900">หน่วยงาน:</b> ${rec.organizer}</p>
                            <p><i class="ph ph-map-pin text-gray-400 mr-1"></i> <b class="font-semibold text-gray-900">สถานที่:</b> ${rec.location}</p>
                        </div>
                        ${rec.fileUrl ? `<div class="mt-4 pt-4 border-t border-gray-100"><button onclick="viewFile('${rec.id}')" class="text-sm text-blue-600 font-bold inline-flex items-center gap-1.5 hover:text-blue-800 bg-blue-50 px-3 py-1.5 rounded-lg transition"><i class="ph ph-file-pdf text-lg"></i> ดูใบเซอร์/เอกสารแนบ</button></div>` : ''}
                    </div>`;
                displayIndex++;
            });
            recordsContainer.innerHTML += html + '</div></div>';
        });
    };

    // ==========================================
    // Modals & Submissions
    // ==========================================
    document.getElementById('form-add-record').addEventListener('submit', async (e) => {
        e.preventDefault();
        showToast('กำลังบันทึกข้อมูล...', 'info');
        try {
            const countSnap = await getCountFromServer(collection(db, "training_records"));
            const nextId = (countSnap.data().count + 1).toString().padStart(3, '0');
            
            let fileBase64 = "";
            const fileInput = document.getElementById('add-record-file');
            if (fileInput.files.length > 0) { fileBase64 = await fileToBase64(fileInput.files[0]); }

            const data = {
                numericId: nextId,
                userId: currentUser.id,
                course: document.getElementById('add-record-course').value,
                type: document.getElementById('add-record-type').value,
                typeOther: document.getElementById('add-record-type-other').value,
                organizer: document.getElementById('add-record-organizer').value,
                location: document.getElementById('add-record-location').value,
                date: document.getElementById('add-record-date').value, // value จาก datetime-local จะเป็น format "YYYY-MM-DDTHH:mm"
                fileUrl: fileBase64,
                createdAt: new Date()
            };

            await setDoc(doc(db, "training_records", nextId), data);
            if (currentUser) await logActivity("Add_Training", `เพิ่มประวัติการอบรม: ${data.course} (ID: ${nextId})`);
            
            window.closeAddRecordModal(); 
            showToast(`บันทึกสำเร็จ (ID: ${nextId})`, 'success'); 
            await renderEmployeeDashboard(); 
        } catch (err) { showToast('ล้มเหลว: ' + err.message, 'error'); }
    });

    window.openAddRecordModal = () => { 
        document.getElementById('form-add-record').reset(); 
        document.getElementById('add-record-emp-name').value = currentUser.name;
        document.getElementById('modal-add-record').classList.remove('hidden'); 
    };
    window.closeAddRecordModal = () => { document.getElementById('modal-add-record').classList.add('hidden'); };
    window.toggleAddRecordType = () => {
        const isOther = document.getElementById('add-record-type').value === 'OTHER';
        document.getElementById('add-record-type-other').classList.toggle('hidden', !isOther);
    };

    // --- Delete Logic ---
    window.openDeleteModal = (id) => {
        deletingRecordId = id;
        document.getElementById('modal-delete-confirm').classList.remove('hidden');
    };
    window.closeDeleteModal = () => {
        deletingRecordId = null;
        document.getElementById('modal-delete-confirm').classList.add('hidden');
    };
    window.confirmDelete = async () => {
        if (!deletingRecordId) return;
        try {
            await deleteDoc(doc(db, "training_records", deletingRecordId));
            await logActivity("Delete_Training", `ลบข้อมูลการอบรม ID: ${deletingRecordId}`);
            closeDeleteModal();
            showToast('ลบข้อมูลสำเร็จ', 'success');
            await renderEmployeeDashboard();
        } catch(err) {
            showToast('ลบข้อมูลล้มเหลว', 'error');
        }
    };

    // --- Edit Logic ---
    window.closeVerifyPinModal = () => { document.getElementById('modal-verify-pin').classList.add('hidden'); editingRecordId = null; };
    window.closeEditRecordModal = () => { document.getElementById('modal-edit-record').classList.add('hidden'); editingRecordId = null; };
    window.toggleEditRecordType = () => {
        const isOther = document.getElementById('edit-record-type').value === 'OTHER';
        document.getElementById('edit-record-type-other').classList.toggle('hidden', !isOther);
    };

    window.requestEditRecord = async (id) => {
        editingRecordId = id;
        document.getElementById('verify-pin-input').value = '';
        document.getElementById('modal-verify-pin').classList.remove('hidden');
    };

    document.getElementById('form-verify-pin').onsubmit = async (e) => {
        e.preventDefault();
        if (document.getElementById('verify-pin-input').value === currentUser.pin) {
            document.getElementById('modal-verify-pin').classList.add('hidden');
            const rec = window.loadedRecords[editingRecordId];
            if (rec) {
                document.getElementById('edit-record-emp-name').value = currentUser.name;
                document.getElementById('edit-record-course').value = rec.course;
                document.getElementById('edit-record-type').value = rec.type;
                document.getElementById('edit-record-organizer').value = rec.organizer;
                document.getElementById('edit-record-location').value = rec.location;
                
                // สำหรับข้อมูลเก่าที่บันทึกแค่ date (ไม่มี T) ให้แสดงผลเวลา 00:00 เป็นค่าเริ่มต้น
                let dateVal = rec.date;
                if(dateVal && !dateVal.includes('T')) dateVal += 'T00:00';
                document.getElementById('edit-record-date').value = dateVal;
                
                const typeOtherInput = document.getElementById('edit-record-type-other');
                if (rec.type === 'OTHER') { typeOtherInput.value = rec.typeOther || ''; typeOtherInput.classList.remove('hidden'); } 
                else { typeOtherInput.classList.add('hidden'); }
                
                document.getElementById('modal-edit-record').classList.remove('hidden');
            } else { showToast('ไม่พบข้อมูลประวัตินี้', 'error'); }
        } else { showToast('รหัส PIN ไม่ถูกต้อง', 'error'); }
    };

    document.getElementById('form-edit-record').onsubmit = async (e) => {
        e.preventDefault();
        showToast('กำลังบันทึกการแก้ไข...', 'info');
        try {
            const fileInput = document.getElementById('edit-record-file');
            let updateData = {
                course: document.getElementById('edit-record-course').value,
                type: document.getElementById('edit-record-type').value,
                organizer: document.getElementById('edit-record-organizer').value,
                location: document.getElementById('edit-record-location').value,
                date: document.getElementById('edit-record-date').value
            };

            if (fileInput.files.length > 0) {
                const newFileBase64 = await fileToBase64(fileInput.files[0]);
                updateData.fileUrl = newFileBase64;
            }

            await updateDoc(doc(db, "training_records", editingRecordId), updateData);
            await logActivity("Edit_Training", `แก้ไขข้อมูลการอบรม ID: ${editingRecordId}`);

            document.getElementById('modal-edit-record').classList.add('hidden');
            showToast('แก้ไขข้อมูลสำเร็จ', 'success'); 
            await renderEmployeeDashboard();
        } catch (err) { console.error(err); showToast('แก้ไขล้มเหลว: ' + err.message, 'error'); }
    };

    // --- Profile Logic ---
    window.openEditProfileModal = () => {
        document.getElementById('edit-profile-name').value = currentUser.name;
        document.getElementById('edit-profile-position').value = currentUser.position || '';
        document.getElementById('edit-profile-email').value = currentUser.email || '';
        document.getElementById('edit-profile-pic').value = ''; 
        document.getElementById('modal-edit-profile').classList.remove('hidden');
    };
    window.closeEditProfileModal = () => { document.getElementById('modal-edit-profile').classList.add('hidden'); };

    document.getElementById('form-edit-profile').onsubmit = async (e) => {
        e.preventDefault();
        showToast('กำลังอัปเดตโปรไฟล์...', 'info');
        let picBase64 = currentUser.profilePic || "";
        const fileIn = document.getElementById('edit-profile-pic');
        if (fileIn.files.length > 0) { picBase64 = await fileToBase64(fileIn.files[0]); }

        const updateData = {
            name: document.getElementById('edit-profile-name').value,
            position: document.getElementById('edit-profile-position').value,
            email: document.getElementById('edit-profile-email').value,
            profilePic: picBase64
        };
        await updateDoc(doc(db, "users", currentUser.id), updateData);
        Object.assign(currentUser, updateData);
        document.getElementById('modal-edit-profile').classList.add('hidden');
        renderEmployeeDashboard(); 
        await logActivity("Update_Profile", `อัปเดตข้อมูลส่วนตัว/รูปโปรไฟล์`);
        showToast('อัปเดตสำเร็จ', 'success');
    };

    navigateTo('view-login');
    </script>
</body>
</html>
